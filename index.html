<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Silay Explorer Prototype</title>
<link rel="icon" type="image/png" href="LOVE SILAY.png">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
<style>
/* --- 1. LOAD THE CUSTOM FONT --- */
@font-face {
    font-family: 'Barabara';
    src: url('BARABARA-final.woff') format('woff'); 
    font-weight: normal;
    font-style: normal;
}

    :root {
        --primary-green: #2F5245; /* Dark Green */
        --secondary-green: #5C8C7A;
        --light-bg: #F4F6F5;
        --text-dark: #1A1A1A;
        --white: #FFFFFF;
        --gray: #888888;
        --chat-user-bg: #2F5245;
        --chat-bot-bg: #E0E0E0;
        --red-alert: #FF4B4B;
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: 'Poppins', sans-serif;
    }

    body {
        background-color: #e0e0e0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
    }

    /* Mobile Container */
    .app-container {
        width: 100%;
        max-width: 414px; /* Phone width */
        height: 100vh;
        max-height: 896px;
        background-color: var(--light-bg);
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }

    /* Screen Management */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto;
        display: none; /* Hidden by default */
        background: var(--light-bg);
        padding-bottom: 20px;
    }

    /* FIX: Specific display for Landing Screen */
    #landing-screen {
        display: none; /* Default hidden */
        flex-direction: column;
        justify-content: flex-end;
        align-items: center;
        text-align: center;
        padding: 60px 20px;
    }

    .screen.active {
        animation: fadeIn 0.3s ease-in-out;
    }
    
    /* When landing screen is active, it must be flex, others block */
    #landing-screen.active { display: flex; }
    .screen:not(#landing-screen).active { display: block; }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* --- LOADING SCREEN CSS (NEW) --- */
    #preloader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: var(--primary-green);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: white;
        transition: opacity 0.5s ease-out;
    }

    .loader-logo {
        font-family: 'Barabara';
        font-size: 2.5rem;
        margin-bottom: 20px;
        letter-spacing: 2px;
        animation: float 2s ease-in-out infinite;

        text-align: center;      /* Forces text to center if it wraps */
        width: 100%;             /* Ensures it spans the full width */
        padding: 0 20px;         /* Adds breathing room on the sides */
        line-height: 1.2;        /* Adjusts spacing between SILAY and EXPLORER */
        word-wrap: break-word;   /* Ensures long words don't break layout */
    }

    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }

    .connection-status {
        font-size: 0.85rem;
        opacity: 0.8;
        margin-top: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Spinner Animation */
    .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* --- AUTHENTICATION SCREENS CSS --- */
    .auth-container {
        padding: 40px 30px;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .auth-header {
        text-align: center;
        margin-bottom: 40px;
    }

    .auth-header h1 {
        font-family: 'Barabara';
        color: var(--primary-green);
        font-size: 2rem;
        letter-spacing: 1px;
    }

    .auth-header p {
        color: #666;
        font-size: 0.9rem;
        margin-top: 10px;
    }

    .input-group {
        margin-bottom: 20px;
        position: relative;
    }

    .input-group i {
        position: absolute;
        top: 50%;
        left: 20px;
        transform: translateY(-50%);
        color: #aaa;
    }

    .auth-input {
        width: 100%;
        padding: 15px 15px 15px 50px; /* Space for icon */
        border-radius: 30px;
        border: 1px solid #ddd;
        background: white;
        font-size: 0.95rem;
        outline: none;
        transition: border 0.3s;
    }

    .auth-input:focus {
        border-color: var(--primary-green);
    }

    .auth-footer {
        margin-top: 30px;
        text-align: center;
        font-size: 0.9rem;
        color: #666;
    }

    .auth-link {
        color: var(--primary-green);
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
    }

    /* --- SIDE MENU DRAWER (LEFT) --- */
    .side-menu {
        position: absolute;
        top: 0;
        left: -100%; 
        width: 75%;
        height: 100%;
        background: white;
        z-index: 2000;
        transition: left 0.3s ease-in-out;
        box-shadow: 4px 0 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .side-menu.active { left: 0; }

    /* --- NOTIFICATION DRAWER (RIGHT) --- */
    .notif-drawer {
        position: absolute;
        top: 0;
        right: -100%; /* Hidden on right */
        width: 80%;
        height: 100%;
        background: white;
        z-index: 2001;
        transition: right 0.3s ease-in-out;
        box-shadow: -4px 0 15px rgba(0,0,0,0.1);
        display: flex;
        flex-direction: column;
    }

    .notif-drawer.active { right: 0; }

    /* Shared Overlay for Menus */
    .menu-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 1999;
        display: none;
    }
    
    .menu-overlay.active { display: block; }

    .menu-header {
        background: var(--primary-green);
        padding: 40px 20px 20px 20px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .menu-list {
        list-style: none;
        padding: 20px;
    }

    .menu-list li {
        padding: 15px 0;
        border-bottom: 1px solid #f0f0f0;
        color: var(--text-dark);
        font-size: 1rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .menu-list li:active { opacity: 0.6; }

    /* Notification Items Style */
    .notif-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        gap: 15px;
        align-items: flex-start;
        cursor: pointer;
        transition: background 0.2s;
        animation: slideInLeft 0.3s ease-out; /* Animation for new items */
    }

    @keyframes slideInLeft {
        from { transform: translateX(20px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    .notif-item:active { background: #f9f9f9; }
    
    .notif-item.unread { background: #f0f7f4; }

    .notif-icon-box {
        width: 40px;
        height: 40px;
        background: #e0e0e0;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: var(--primary-green);
        flex-shrink: 0;
    }

    .notif-text h4 { font-size: 0.9rem; margin-bottom: 3px; color: var(--text-dark); }
    .notif-text p { font-size: 0.75rem; color: #666; line-height: 1.3; }
    .notif-time { font-size: 0.65rem; color: #999; margin-top: 5px; display: block; }

    /* --- TOAST NOTIFICATION (POP UP) --- */
    .toast-notification {
        position: absolute;
        top: -120px; /* Hidden initially */
        left: 15px;
        right: 15px;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        z-index: 3000;
        display: flex;
        gap: 15px;
        align-items: center;
        transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .toast-notification.show {
        top: 20px; /* Slides down */
    }

    .toast-icon {
        width: 40px;
        height: 40px;
        background: #e8f5e9;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-green);
        font-size: 1.2rem;
    }

    /* --- SCREEN 1: LANDING --- */
    #landing-screen {
        background-image: url('landing screen1.jpg'); 
        background-size: cover;
        background-position: center;
    }

    .landing-content h1 {
        font-family: 'Barabara', sans-serif;
        text-transform: uppercase;
        color: white;
        font-size: 2rem;      
        white-space: nowrap;    
        letter-spacing: 1px;    
        line-height: 1;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }

    .landing-content p {
        font-family: 'Montserrat', sans-serif;
        color: #f0f0f0;
        font-size: 1rem;
        margin-bottom: 40px;
    }

    .btn-primary {
        background-color: var(--primary-green);
        color: white;
        border: none;
        padding: 16px 50px;
        border-radius: 30px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        transition: transform 0.1s;
    }

    .btn-primary:active { transform: scale(0.98); }

    /* --- SCREEN 2: HOME --- */
    .home-header {
        background: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.4)), url('homehead.jpg') center/cover;
        height: 250px;
        padding: 20px;
        color: white;
        display: flex;
        flex-direction: column;
        justify-content: flex-end;
        position: relative;
    }

    .top-nav {
        position: absolute;
        top: 40px;
        left: 20px;
        right: 20px;
        display: flex;
        justify-content: space-between;
        color: white;
        font-size: 1.2rem;
        z-index: 10;
    }

    /* Red Dot Badge */
    .bell-wrapper {
        position: relative;
        cursor: pointer;
    }

    .red-dot {
        position: absolute;
        top: -2px;
        right: -1px;
        width: 10px;
        height: 10px;
        background-color: var(--red-alert);
        border-radius: 50%;
        border: 2px solid white;
        display: none; 
        animation: pulse 2s infinite;
    }

    .red-dot.visible { display: block; }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    .search-bar {
        background: white;
        border-radius: 25px;
        padding: 12px 20px;
        margin-top: 15px;
        display: flex;
        align-items: center;
        color: var(--gray);
        font-size: 0.9rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* --- SHARED SEARCH DROPDOWN STYLES --- */
    .search-dropdown {
        position: absolute;
        top: 55px; /* Just below the search bar */
        left: 0;
        width: 100%;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        z-index: 3000;
        max-height: 300px;
        overflow-y: auto;
        display: none; 
    }

    .search-dropdown.active { display: block; }

    .search-item {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: background 0.2s;
        background: white;
    }

    .search-item:active { background: #f5f5f5; }

    .search-item h4 { font-size: 0.9rem; color: var(--text-dark); margin: 0; }
    .search-item p { font-size: 0.75rem; color: #888; margin: 0; }

    /* --- MAP SPECIFIC SEARCH STYLES --- */
    .map-search-container {
        position: absolute;
        top: 20px;
        left: 20px;
        right: 20px;
        z-index: 2000; /* Above Leaflet map */
    }

    .map-search-bar {
        background: white;
        border-radius: 30px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    }

    .menu-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 20px;
    }

    .menu-btn {
        background: white;
        border: 1px solid #eee;
        border-radius: 15px;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        transition: 0.2s;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .menu-btn:active { background-color: #f0f0f0; }

    .menu-btn i {
        font-size: 1.4rem;
        color: var(--primary-green);
    }

    .menu-btn h4 { font-size: 0.9rem; color: var(--text-dark); margin-bottom: 2px; }
    .menu-btn p { font-size: 0.7rem; color: var(--gray); }

    .section-title {
        padding: 0 20px;
        font-size: 1.2rem;
        color: var(--primary-green);
        font-weight: 700;
        margin-top: 10px;
    }

    .card-scroll {
        display: flex;
        overflow-x: auto;
        padding: 15px 20px;
        gap: 15px;
        scrollbar-width: none;
        padding-right: 20px; 
    }
    .card-scroll::-webkit-scrollbar { display: none; }

    .card {
        width: 280px;       /* Fixed width */
        height: 180px;      /* Fixed height */
        background: var(--primary-green);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        flex-shrink: 0;    
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .card img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0.85;
        transition: opacity 0.2s;
    }
    
    .card:active img { opacity: 0.6; }

    .card-text {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 15px;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        color: white;
    }

    /* --- ITINERARY SETUP SCREEN CSS --- */
    .setup-container {
        padding: 20px;
    }

    .pref-section {
        margin-bottom: 30px;
    }

    .pref-title {
        font-size: 1.1rem;
        color: var(--text-dark);
        margin-bottom: 15px;
        font-weight: 600;
    }

    .chip-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
    }

    .chip {
        padding: 10px 20px;
        border-radius: 25px;
        background: white;
        border: 1px solid #ddd;
        color: #555;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.2s;
    }

    .chip.selected {
        background: var(--primary-green);
        color: white;
        border-color: var(--primary-green);
        box-shadow: 0 4px 10px rgba(47, 82, 69, 0.3);
    }

    /* --- CUSTOM ITINERARY BUILDER STYLES (NEW) --- */
    .or-divider {
        display: flex;
        align-items: center;
        text-align: center;
        margin: 30px 0;
        color: #aaa;
        font-size: 0.8rem;
    }
    .or-divider::before, .or-divider::after {
        content: '';
        flex: 1;
        border-bottom: 1px solid #ddd;
    }
    .or-divider::before { margin-right: 10px; }
    .or-divider::after { margin-left: 10px; }

    .custom-list-item {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid #eee;
        transition: 0.2s;
        cursor: pointer;
    }

    .custom-list-item.selected {
        border-color: var(--primary-green);
        background: #e8f5e9;
    }

    .custom-check {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        transition: 0.2s;
    }

    .custom-list-item.selected .custom-check {
        background: var(--primary-green);
        border-color: var(--primary-green);
    }
    
    .selection-counter {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: white;
        padding: 20px;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        z-index: 100;
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
    }

    /* --- SCREEN 3: ITINERARY RESULT --- */
    .page-header {
        background: #e8eceb;
        padding: 50px 20px 20px;
        border-bottom-left-radius: 25px;
        border-bottom-right-radius: 25px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    
    .header-title h2 { font-size: 1.3rem; color: var(--text-dark); }
    .header-title p { font-size: 0.85rem; color: #666; }

    .itinerary-card {
        background: #ffffff;
        margin: 15px 20px;
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border-left: 5px solid var(--primary-green);
    }

    .itinerary-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        color: var(--primary-green);
        font-weight: 700;
        font-size: 1rem;
    }

    .dynamic-list {
        list-style: none;
        padding: 0;
    }

    .dynamic-item {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        padding: 10px 0;
        border-bottom: 1px solid #f4f4f4;
    }

    .dynamic-item:last-child { border-bottom: none; }

    .item-checkbox {
        width: 18px;
        height: 18px;
        margin-top: 3px;
        accent-color: var(--primary-green);
        cursor: pointer;
    }

    .item-info h4 { font-size: 0.9rem; color: #333; margin-bottom: 2px; }
    .item-info p { font-size: 0.75rem; color: #888; }
    .item-time { font-size: 0.75rem; color: var(--secondary-green); font-weight: 600; display: block; margin-bottom: 2px;}

    /* Style for unchecked/checked items */
    .dynamic-item.disabled .item-info { opacity: 0.5; text-decoration: line-through; }

    /* --- SHARED UI --- */
    .back-btn {
        position: absolute;
        top: 40px;
        left: 20px;
        background: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 100;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        color: var(--text-dark);
    }

    /* --- SCREEN 4: INTERACTIVE MAP (Leaflet) --- */
    #map-screen {
        position: relative;
        background-color: #eee;
    }

    .real-map-container {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        z-index: 0; /* Map stays in background */
    }

    /* Leaflet container */
    #leaflet-map {
        width: 100%;
        height: 100%;
    }
    .leaflet-bottom {
        bottom: 90px !important; /* Move attribution up above bottom sheet */
    }

    .bottom-sheet {
        position: absolute;
        bottom: 25px;
        left: 15px;
        right: 15px;
        background: #2a3d35; /* Dark UI from screenshot */
        border-radius: 25px;
        padding: 25px;
        color: white;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        z-index: 2000; /* Ensure it's on top of the map */
    }

    .sheet-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    .action-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        padding: 12px 5px;
        border-radius: 12px;
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 5px;
        font-size: 0.75rem;
        cursor: pointer;
    }
    
    .action-btn.green-highlight { background: #4CAF50; color: white; }
    .action-btn:active { opacity: 0.7; }

    /* Map Photos Container */
    .map-photos {
        display: flex; 
        gap: 10px; 
        margin-top: 25px;
        overflow-x: auto;
    }
    .map-photo {
        width: 120px; 
        height: 80px; 
        object-fit: cover; 
        border-radius: 12px;
        flex-shrink: 0;
        background: #444;
    }

    /* --- SCREEN 5: DETAIL --- */
    .detail-img {
        width: 100%;
        height: 380px;
        object-fit: cover;
        border-bottom-left-radius: 35px;
        border-bottom-right-radius: 35px;
    }

    .detail-content {
        padding: 25px;
        background: var(--light-bg);
    }

    .detail-tabs {
        display: flex;
        gap: 25px;
        margin: 20px 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 10px;
    }

    .tab {
        font-weight: 600;
        color: var(--gray);
        cursor: pointer;
        padding-bottom: 5px;
        font-size: 0.95rem;
    }
    .tab.active { color: var(--primary-green); border-bottom: 3px solid var(--primary-green); }

    /* --- SCREEN 6: EVENTS (UPDATED FOR DYNAMIC CALENDAR) --- */
    .calendar-header {
        padding: 50px 20px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: white;
    }
    
    .calendar-grid {
        padding: 10px 25px;
        background: white;
        margin-bottom: 20px;
        border-bottom-left-radius: 20px;
        border-bottom-right-radius: 20px;
    }
    
    .cal-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
    }
    
    .cal-day { font-weight: bold; width: 30px; text-align: center; font-size: 0.9rem; color: var(--gray); }
    .cal-date { width: 30px; height: 30px; line-height: 30px; text-align: center; color: #333; font-size: 0.95rem; }
    .cal-date.selected { background: #111; color: white; border-radius: 50%; }

    .event-card {
        margin: 0 20px;
        background: white;
        border-radius: 18px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    /* --- NEW CALENDAR STYLES --- */
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 25px;
        margin-bottom: 15px;
    }

    .calendar-controls i {
        cursor: pointer;
        padding: 10px;
        color: var(--primary-green);
    }

    .cal-date {
        position: relative;
        cursor: pointer;
        transition: 0.2s;
    }

    /* The little dot below dates with events */
    .event-indicator {
        position: absolute;
        bottom: 3px;
        left: 50%;
        transform: translateX(-50%);
        width: 5px;
        height: 5px;
        background-color: var(--red-alert);
        border-radius: 50%;
        display: none;
    }

    .cal-date.has-event .event-indicator {
        display: block;
    }

    .cal-date.today {
        border: 2px solid var(--primary-green);
        border-radius: 50%;
        font-weight: bold;
    }

    /* --- QR SCANNER SCREEN CSS --- */
    #qr-screen {
        background-color: black;
        display: none;
    }

    #qr-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        position: absolute;
        top: 0;
        left: 0;
    }

    .scan-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 5;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .scan-box {
        width: 250px;
        height: 250px;
        border: 2px solid rgba(255,255,255,0.5);
        position: relative;
        border-radius: 20px;
        box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); /* Darkens area outside box */
    }

    /* Corner accents */
    .scan-box::before, .scan-box::after {
        content: '';
        position: absolute;
        width: 40px;
        height: 40px;
        border-color: var(--primary-green); /* Green corners */
        border-style: solid;
        transition: all 0.2s;
    }

    .scan-box::before {
        top: -2px; left: -2px;
        border-width: 4px 0 0 4px;
        border-top-left-radius: 20px;
    }

    .scan-box::after {
        bottom: -2px; right: -2px;
        border-width: 0 4px 4px 0;
        border-bottom-right-radius: 20px;
    }

    .scan-text {
        color: white;
        margin-top: 20px;
        font-size: 0.9rem;
        z-index: 10;
        text-align: center;
    }

    /* Animation for the scanning line */
    .scan-line {
        width: 100%;
        height: 2px;
        background: var(--primary-green);
        position: absolute;
        top: 10%;
        box-shadow: 0 0 4px var(--primary-green);
        animation: scanMove 2s infinite linear;
    }

    @keyframes scanMove {
        0% { top: 10%; opacity: 0; }
        50% { opacity: 1; }
        100% { top: 90%; opacity: 0; }
    }

    /* --- NEW AI CHAT CSS --- */
    .chat-fab {
        position: absolute;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        background-color: var(--primary-green);
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 999; /* Float on top */
        transition: transform 0.2s;
    }

    .chat-fab:active { transform: scale(0.9); }

    .chat-screen-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: white;
        z-index: 1000;
        display: none;
        flex-direction: column;
    }

    .chat-header {
        background: var(--primary-green);
        padding: 20px;
        padding-top: 40px; /* Safe area for status bar */
        color: white;
        display: flex;
        align-items: center;
        gap: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #f4f6f5;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .message {
        max-width: 80%;
        padding: 12px 16px;
        border-radius: 18px;
        font-size: 0.95rem;
        line-height: 1.4;
    }

    .message.user {
        background-color: var(--primary-green);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .message.bot {
        background-color: #e0e0e0;
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }

    .typing-indicator {
        font-size: 0.8rem;
        color: #888;
        margin-left: 10px;
        font-style: italic;
        display: none;
    }

    .chat-input-area {
        padding: 15px;
        background: white;
        border-top: 1px solid #eee;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .chat-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 25px;
        outline: none;
        font-size: 1rem;
    }

    .send-btn {
        background: var(--primary-green);
        color: white;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        border: none;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    /* --- ABOUT PAGE CSS --- */
    .about-logo {
        width: 100px;
        height: 100px;
        background: var(--primary-green);
        border-radius: 25px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 40px auto 20px;
        color: white;
        font-size: 3rem;
        box-shadow: 0 10px 20px rgba(47, 82, 69, 0.2);
    }

    .about-content {
        padding: 30px;
        text-align: center;
    }

    .version-tag {
        background: #e0e0e0;
        color: #555;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.8rem;
        display: inline-block;
        margin-bottom: 20px;
    }

    .developer-section {
        margin-top: 40px;
        border-top: 1px solid #eee;
        padding-top: 30px;
    }

    /* --- HELP SCREEN CSS --- */
    .help-step {
        display: flex;
        gap: 20px;
        padding: 20px;
        border-bottom: 1px solid #eee;
        align-items: flex-start;
    }
    
    .help-icon {
        width: 50px;
        height: 50px;
        background: #e8f5e9;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--primary-green);
        font-size: 1.5rem;
        flex-shrink: 0;
    }

    .help-text h3 {
        font-size: 1rem;
        color: var(--text-dark);
        margin-bottom: 5px;
    }

    .help-text p {
        font-size: 0.85rem;
        color: #666;
        line-height: 1.5;
    }

    /* --- SUPPORT & PRIVACY SCREEN STYLES (NEW) --- */
    .text-content {
        padding: 25px;
        background: white;
        margin-top: -20px; /* Overlap header slightly */
        border-top-left-radius: 30px;
        border-top-right-radius: 30px;
        min-height: 500px;
    }

    .text-content h3 {
        color: var(--primary-green);
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .text-content p {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.6;
        margin-bottom: 15px;
    }

    .support-card {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
        border: 1px solid #eee;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .support-card:active {
        transform: scale(0.98);
        background: #e8f5e9;
    }

    .support-icon {
        width: 50px;
        height: 50px;
        background: white;
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.5rem;
        color: var(--primary-green);
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
</style>
</head>
<body>

    <div class="app-container">
    
        <div id="preloader">
            <h2 class="loader-logo">SILAY EXPLORER</h2>
            <div class="spinner"></div>
            <div class="connection-status">
                <i class="fas fa-wifi"></i>
                <span id="loading-text">Connecting...</span>
            </div>
        </div>

        <div id="menu-overlay" class="menu-overlay" onclick="closeAllMenus()"></div>

        <div id="toast-notification" class="toast-notification">
            <div id="toast-icon-container" class="toast-icon">
                <i class="fas fa-info-circle"></i>
            </div>
            <div style="flex: 1;">
                <h4 id="toast-title" style="font-size: 0.9rem; margin-bottom: 2px;">Notification</h4>
                <p id="toast-msg" style="font-size: 0.8rem; color: #666;">Message goes here.</p>
            </div>
        </div>
        
        <div id="side-menu" class="side-menu">
            <div class="menu-header">
                <h2 style="font-family: 'Barabara'; letter-spacing: 1px; margin: 0;">SILAY EXPLORER</h2>
                <i class="fas fa-times" onclick="toggleMenu()" style="cursor: pointer; font-size: 1.2rem;"></i>
            </div>
            <ul class="menu-list">
                <li onclick="toggleMenu(); showScreen('home-screen')"><i class="fas fa-home"></i> Home</li>
                <li onclick="toggleMenu(); showScreen('map-screen')"><i class="fas fa-map-marked-alt"></i> Map Guide</li>
                <li onclick="toggleMenu(); showScreen('events-screen')"><i class="fas fa-calendar-alt"></i> Events</li>
                <li onclick="toggleMenu(); openQRScanner()"><i class="fas fa-qrcode"></i> QR Scanner</li>
                <li onclick="toggleMenu(); checkItinerary()"><i class="fas fa-clipboard-list"></i> My Itinerary</li>
                <li onclick="toggleMenu(); showScreen('help-screen')"><i class="fas fa-question-circle"></i> How to Use</li>
                <li onclick="toggleMenu(); showScreen('about-screen')"><i class="fas fa-info-circle"></i> About App</li>
                <li onclick="toggleMenu(); showScreen('support-screen')"><i class="fas fa-heart"></i> Support Us</li>
                <li onclick="toggleMenu(); showScreen('privacy-screen')"><i class="fas fa-user-shield"></i> Privacy Policy</li>
                <li onclick="handleLogout()" style="color: var(--red-alert); border-bottom: none;"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
            <div style="margin-top: auto; padding: 20px; text-align: center; color: #aaa; font-size: 0.8rem;">
                <p>Version 1.2.0 Prototype</p>
            </div>
        </div>

        <div id="notif-drawer" class="notif-drawer">
            <div class="menu-header">
                <h3 style="margin: 0;">Notifications</h3>
                <i class="fas fa-times" onclick="toggleNotifications()" style="cursor: pointer; font-size: 1.2rem;"></i>
            </div>
            <div id="notif-list" style="flex: 1; overflow-y: auto;">
                <div class="notif-item unread" onclick="toggleNotifications(); showScreen('events-screen');">
                    <div class="notif-icon-box"><i class="fas fa-calendar-check"></i></div>
                    <div class="notif-text">
                        <h4>Upcoming Event: Kansilay</h4>
                        <p>The annual festival starts in 2 days at the Public Plaza. Don't miss the parade!</p>
                        <span class="notif-time">2 mins ago</span>
                    </div>
                </div>
                <div class="notif-item">
                    <div class="notif-icon-box" style="color: #E91E63;"><i class="fas fa-heart"></i></div>
                    <div class="notif-text">
                        <h4>Welcome to Silay!</h4>
                        <p>Thank you for using Silay Explorer. Check out our Heritage guide.</p>
                        <span class="notif-time">1 hour ago</span>
                    </div>
                </div>
                <div class="notif-item">
                    <div class="notif-icon-box" style="color: #2196F3;"><i class="fas fa-cloud-sun"></i></div>
                    <div class="notif-text">
                        <h4>Weather Update</h4>
                        <p>It's a sunny day in Silay City. Perfect for a walking tour!</p>
                        <span class="notif-time">5 hours ago</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="landing-screen" class="screen active">
            <div class="landing-content">
                <h1>SILAY EXPLORER</h1>
                <p>Discover, Experience, and Explore the Paris of Negros!</p>
                <button class="btn-primary" onclick="showScreen('login-screen')">Explore Now!</button>
            </div>
        </div>

        <div id="login-screen" class="screen">
            <div class="back-btn" onclick="showScreen('landing-screen')" style="top: 40px; left: 20px;">
                <i class="fas fa-arrow-left"></i>
            </div>

            <div class="auth-container">
                <div class="auth-header">
                    <h1>WELCOME BACK</h1>
                    <p>Sign in to continue exploring Silay.</p>
                </div>

                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="login-email" class="auth-input" placeholder="Email Address">
                </div>

                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-pass" class="auth-input" placeholder="Password">
                </div>

                <div style="text-align: right; margin-bottom: 30px;">
                    <span style="font-size: 0.8rem; color: #888; cursor: pointer;">Forgot Password?</span>
                </div>

                <button class="btn-primary" style="width: 100%; box-shadow: 0 5px 20px rgba(47, 82, 69, 0.3);" onclick="handleLogin()">Sign In</button>

                <div class="auth-footer">
                    <p>Don't have an account? <span class="auth-link" onclick="showScreen('signup-screen')">Sign Up</span></p>
                </div>
            </div>
        </div>

        <div id="signup-screen" class="screen">
            <div class="back-btn" onclick="showScreen('login-screen')" style="top: 40px; left: 20px;">
                <i class="fas fa-arrow-left"></i>
            </div>

            <div class="auth-container">
                <div class="auth-header">
                    <h1>CREATE ACCOUNT</h1>
                    <p>Join the Silay Explorer community.</p>
                </div>

                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="signup-name" class="auth-input" placeholder="Full Name">
                </div>

                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="signup-email" class="auth-input" placeholder="Email Address">
                </div>

                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="signup-pass" class="auth-input" placeholder="Password">
                </div>

                <button class="btn-primary" style="width: 100%; margin-top: 10px; box-shadow: 0 5px 20px rgba(47, 82, 69, 0.3);" onclick="handleSignup()">Sign Up</button>

                <div class="auth-footer">
                    <p>Already have an account? <span class="auth-link" onclick="showScreen('login-screen')">Sign In</span></p>
                </div>
            </div>
        </div>

        <div id="home-screen" class="screen">
            <div class="home-header">
                <div class="top-nav">
                    <i class="fas fa-bars" onclick="toggleMenu()"></i>
                    
                    <div class="bell-wrapper" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <div id="red-dot" class="red-dot"></div>
                    </div>
                </div>
                <div>
                    <h2 style="font-size: 1.5rem; font-weight: 700;">Welcome to Silay</h2>
                    <p style="opacity: 0.9; font-size: 0.85rem;">The Paris of Negros - Where Heritage Meets Adventure   </p>
                    
                    <div class="search-container" style="position: relative;">
                        <div class="search-bar">
                            <i class="fas fa-search" style="margin-right: 10px; color: #aaa;"></i>
                            <input type="text" id="trip-search" placeholder="Search places (e.g. 'Cafe', 'Balay Negrense')" 
                                   style="border: none; outline: none; width: 100%; font-size: 0.9rem; color: #555; background: transparent;"
                                   onkeyup="handleSearch(this.value)">
                            <i class="fas fa-times" id="clear-search" onclick="clearSearch()" style="color: #aaa; cursor: pointer; display: none;"></i>
                        </div>
                        <div id="search-results" class="search-dropdown"></div>
                    </div>

                </div>
            </div>

            <div class="menu-grid">
                <div class="menu-btn" onclick="showScreen('map-screen')">
                    <i class="fas fa-map-marked-alt"></i>
                    <div>
                        <h4>Silay Map</h4>
                        <p>GPS navigation</p>
                    </div>
                </div>
                <div class="menu-btn" onclick="showScreen('events-screen')">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <h4>Events</h4>
                        <p>Find locations</p>
                    </div>
                </div>
                <div class="menu-btn" onclick="openQRScanner()"> 
                    <i class="fas fa-qrcode"></i>
                    <div>
                        <h4>QR Scanner</h4>
                        <p>Instant info</p>
                    </div>
                </div>
                <div class="menu-btn" onclick="showScreen('itinerary-setup-screen')">
                    <i class="fas fa-clipboard-list"></i>
                    <div>
                        <h4>Plan Trip</h4>
                        <p>Create itinerary</p>
                    </div>
                </div>
            </div>

            <h3 class="section-title">Popular Destinations</h3>
            <p style="padding: 0 20px; font-size: 0.85rem; color: #666; margin-bottom: 15px; line-height: 1.4;">
                Breathtaking tourist destinations carved by nature that you can only experience in Silay City.
            </p>
            <div class="card-scroll">
                <div class="card" onclick="openDetail('balay')"> 
                    <img src="heritage head.jpg" alt="Heritage">
                    <div class="card-text">
                        <h4>Heritage Sites</h4>
                        <p style="font-size: 0.75rem; opacity: 0.9;">Ancestral houses...</p>
                    </div>
                </div>
                <div class="card" onclick="openDetail('larga')">
                    <img src="https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=600" alt="Cafe">
                    <div class="card-text">
                        <h4>Caf√©s</h4>
                        <p style="font-size: 0.75rem; opacity: 0.9;">Classic brews...</p>
                    </div>
                </div>
                <div class="card" onclick="openDetail('ilaya')">
                    <img src="https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=600" alt="Nature">
                    <div class="card-text">
                        <h4>Nature</h4>
                        <p style="font-size: 0.75rem; opacity: 0.9;">Highlands & views</p>
                    </div>
                </div>
            </div>

            <div class="chat-fab" onclick="toggleChat()">
                <i class="fas fa-robot"></i>
            </div>
        </div>

        <div id="help-screen" class="screen">
            <div class="back-btn" onclick="returnToMenu()" style="top: 20px; left: 20px; box-shadow: none; border: 1px solid #ddd;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div style="padding: 80px 20px 20px;">
                <h1 style="font-family: 'Barabara'; color: var(--primary-green); margin-bottom: 5px;">How to Use</h1>
                <p style="color: #666; margin-bottom: 30px;">Your quick guide to Silay Explorer.</p>

                <div class="help-step">
                    <div class="help-icon"><i class="fas fa-search"></i></div>
                    <div class="help-text">
                        <h3>1. Discover & Search</h3>
                        <p>Use the search bar on the home screen to find heritage houses, cafes, or specific spots in Silay.</p>
                    </div>
                </div>

                <div class="help-step">
                    <div class="help-icon"><i class="fas fa-map-marked-alt"></i></div>
                    <div class="help-text">
                        <h3>2. Map & Explore</h3>
                        <p>Open the <b>Map Guide</b> to see all locations. Click 'Explore' on any place to get real-time GPS directions via Google Maps.</p>
                    </div>
                </div>

                <div class="help-step">
                    <div class="help-icon"><i class="fas fa-magic"></i></div>
                    <div class="help-text">
                        <h3>3. Plan Your Trip</h3>
                        <p>Go to <b>Plan Trip</b>, select your interests (History, Food, etc.), and let our AI generate a perfect itinerary for you.</p>
                    </div>
                </div>

                <div class="help-step">
                    <div class="help-icon"><i class="fas fa-qrcode"></i></div>
                    <div class="help-text">
                        <h3>4. Scan & Learn</h3>
                        <p>Spot a QR code at a heritage site? Use the <b>QR Scanner</b> to instantly unlock history and details about the location.</p>
                    </div>
                </div>
                
                <div class="help-step" style="border-bottom: none;">
                    <div class="help-icon"><i class="fas fa-robot"></i></div>
                    <div class="help-text">
                        <h3>5. Ask AI Assistant</h3>
                        <p>Tap the robot icon at the bottom right to chat with our AI guide for recommendations and tips!</p>
                    </div>
                </div>

                <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="showScreen('home-screen')">Got it!</button>
            </div>
        </div>

        <div id="itinerary-setup-screen" class="screen">
            <div class="back-btn" onclick="showScreen('home-screen')">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="page-header" style="background: white; border: none; padding-bottom: 0; padding-top: 100px;">
                <div class="header-title">
                    <h2 style="font-size: 1.8rem; color: var(--primary-green);">Personalize<br>Your Trip</h2>
                    <p>Let AI plan for you, or design your own.</p>
                </div>
            </div>

            <div class="setup-container">
                <div class="pref-section">
                    <h3 class="pref-title">1. What are your interests?</h3>
                    <div class="chip-grid">
                        <div class="chip" onclick="togglePref(this, 'history')">Historical Sites</div>
                        <div class="chip" onclick="togglePref(this, 'nature')">Nature & Views</div>
                        <div class="chip" onclick="togglePref(this, 'food')">Food & Cafe</div>
                        <div class="chip" onclick="togglePref(this, 'adventure')">Adventure</div>
                    </div>
                </div>

                <div class="pref-section">
                    <h3 class="pref-title">2. Duration of visit?</h3>
                    <div class="chip-grid">
                        <div class="chip duration-chip" onclick="selectDuration(this, 'half')">Half Day (4 hrs)</div>
                        <div class="chip duration-chip" onclick="selectDuration(this, 'full')">Full Day (8 hrs)</div>
                    </div>
                </div>

                <button class="btn-primary" style="width: 100%;" onclick="generateItinerary()">Generate with AI</button>

                <div class="or-divider">OR</div>

                <button class="btn-primary" style="width: 100%; background: white; color: var(--primary-green); border: 2px solid var(--primary-green);" onclick="openCustomBuilder()">
                    <i class="fas fa-edit"></i> Create My Own
                </button>
            </div>
        </div>

        <div id="custom-itinerary-select-screen" class="screen">
            <div class="back-btn" onclick="showScreen('itinerary-setup-screen')">
                <i class="fas fa-arrow-left"></i>
            </div>

            <div class="page-header" style="padding-top: 90px; padding-bottom: 20px;">
                <div class="header-title">
                    <h2 style="font-size: 1.5rem; color: var(--text-dark);">Select Places</h2>
                    <p>Tap places to add to your list.</p>
                </div>
            </div>

            <div id="custom-list-container" style="padding: 0 20px 100px 20px;">
                </div>

            <div class="selection-counter">
                <div>
                    <h4 style="margin: 0; color: var(--primary-green);"><span id="count-span">0</span> Selected</h4>
                    <p style="margin: 0; font-size: 0.75rem; color: #888;">Build your route</p>
                </div>
                <button class="btn-primary" style="padding: 12px 30px;" onclick="finalizeCustomItinerary()">
                    View Itinerary <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>

        <div id="itinerary-screen" class="screen">
            <div class="back-btn" onclick="showScreen('home-screen')">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="page-header" style="padding-top: 100px;">
                <div style="background: #2F5245; color: white; padding: 12px; border-radius: 50%; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; margin-right: 15px;">
                    <i class="fas fa-suitcase"></i>
                </div>
                <div class="header-title" style="flex: 1;">
                    <h2>Your Trip</h2>
                    <p id="itinerary-subtitle">Calculated for you</p>
                </div>
                <i class="fas fa-redo-alt" onclick="showScreen('itinerary-setup-screen')" style="color: #2F5245; font-size: 1.2rem; cursor: pointer;"></i>
            </div>

            <div class="itinerary-card">
                <div class="itinerary-header">
                    <span>SUGGESTED ROUTE</span>
                    <span id="itinerary-date">Today</span>
                </div>
                <ul class="dynamic-list" id="generated-list">
                    <li style="text-align: center; color: #999; padding: 20px;">
                        No itinerary yet. <br> Go to 'Plan Trip' to create one!
                    </li>
                </ul>
            </div>
            
            <div style="padding: 0 20px;">
                <button class="btn-primary" style="width: 100%; font-size: 0.9rem;" onclick="showScreen('home-screen')">Save & Return Home</button>
            </div>
        </div>

        <div id="map-screen" class="screen">
            <div class="map-search-container">
                <div class="map-search-bar">
                    <i class="fas fa-search" style="margin-right: 10px; color: #aaa;"></i>
                    <input type="text" placeholder="Search map..." 
                           style="border: none; outline: none; width: 100%; font-size: 0.9rem; color: #555; background: transparent;"
                           onkeyup="handleMapSearch(this.value)">
                </div>
                <div id="map-search-results" class="search-dropdown"></div>
            </div>

            <div class="real-map-container">
                <div id="leaflet-map"></div>
            </div>

            <div class="back-btn" onclick="showScreen('home-screen')" style="top: 80px;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="bottom-sheet" id="map-sheet" style="display:none; z-index: 2000;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <h3 id="sheet-title" style="font-size: 1.2rem;"></h3>
                        <p id="sheet-desc" style="font-size: 0.85rem; opacity: 0.7; margin-top: 5px;"></p>
                    </div>
                    <i class="fas fa-times" onclick="closeBottomSheet()" style="cursor: pointer; opacity: 0.7;"></i>
                </div>
                
                <div class="sheet-actions">
                    <button class="action-btn green-highlight" onclick="handleMapAction('explore')">
                        <i class="fas fa-compass"></i>
                        <span>Explore</span>
                    </button>
                    <button class="action-btn" onclick="handleMapAction('call')">
                        <i class="fas fa-phone-alt"></i>
                        <span>Call</span>
                    </button>
                    <button class="action-btn" onclick="handleMapAction('website')">
                        <i class="fas fa-globe"></i>
                        <span>Website</span>
                    </button>
                    <button class="action-btn" onclick="handleMapAction('book')">
                        <i class="fas fa-calendar-check"></i>
                        <span>Book</span>
                    </button>
                </div>
                
                <div class="map-photos" id="sheet-photos">
                    </div>
            </div>
        </div>

        <div id="detail-screen" class="screen">
            <div class="back-btn" onclick="showScreen('home-screen')" style="top: 40px; left: 20px;">
                <i class="fas fa-arrow-left"></i>
            </div>
            <img id="detail-img" src="" class="detail-img">
            
            <div class="detail-content">
                <h2 id="detail-title" style="color: var(--primary-green); font-size: 1.5rem;"></h2>
                <p id="detail-loc" style="color: var(--gray); font-size: 0.9rem; margin-top: 5px;"><i class="fas fa-map-marker-alt"></i></p>
                
                <div class="detail-tabs">
                    <span class="tab active" onclick="switchTab(this)">Overview</span>
                    <span class="tab" onclick="switchTab(this)">Photos</span>
                    <span class="tab" onclick="switchTab(this)">Details</span>
                    <span class="tab" onclick="switchTab(this)">Reviews</span>
                </div>

                <p id="detail-desc" style="font-size: 0.95rem; color: #555; line-height: 1.6;"></p>

                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn-primary" onclick="showScreen('map-screen')" style="flex: 2; padding: 15px; box-shadow: none;">Explore</button>
                    <button id="bookmark-btn" class="btn-primary" onclick="toggleBookmark(this)" style="flex: 1; background: white; color: var(--primary-green); border: 2px solid var(--primary-green); padding: 15px; box-shadow: none;">
                        <i class="far fa-bookmark"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="events-screen" class="screen">
            <div class="calendar-header">
                <div class="back-btn" onclick="showScreen('home-screen')" style="position: static; box-shadow: none; border: 1px solid #eee; margin: 0;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h2 id="current-year">2025</h2> <i class="fas fa-calendar-day" onclick="goToToday()" style="font-size: 1.2rem; color: var(--primary-green); cursor: pointer;"></i>
            </div>
            
            <div class="calendar-controls">
                <i class="fas fa-chevron-left" onclick="changeMonth(-1)"></i>
                <h1 id="current-month" style="margin: 0;">Month</h1>
                <i class="fas fa-chevron-right" onclick="changeMonth(1)"></i>
            </div>

            <div class="calendar-grid">
                <div class="cal-row">
                    <div class="cal-day">S</div><div class="cal-day">M</div><div class="cal-day">T</div><div class="cal-day">W</div><div class="cal-day">T</div><div class="cal-day">F</div><div class="cal-day">S</div>
                </div>
                <div id="calendar-days" style="display: flex; flex-wrap: wrap;"></div>
            </div>
            
            <h3 style="padding: 0 25px; margin-bottom: 15px; color: var(--primary-green);">Upcoming Events</h3>

            <div id="upcoming-events-container" style="padding-bottom: 80px;">
                </div>
        </div>

        <div id="qr-screen" class="screen" style="background: black;">
            <video id="qr-video" playsinline style="width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;"></video>
            
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 5;">
                <div style="width: 250px; height: 250px; border: 2px solid rgba(255,255,255,0.3); border-radius: 20px; position: relative; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5);">
                    <div style="position: absolute; top: -2px; left: -2px; width: 40px; height: 40px; border-left: 4px solid #4CAF50; border-top: 4px solid #4CAF50; border-top-left-radius: 20px;"></div>
                    <div style="position: absolute; top: -2px; right: -2px; width: 40px; height: 40px; border-right: 4px solid #4CAF50; border-top: 4px solid #4CAF50; border-top-right-radius: 20px;"></div>
                    <div style="position: absolute; bottom: -2px; left: -2px; width: 40px; height: 40px; border-left: 4px solid #4CAF50; border-bottom: 4px solid #4CAF50; border-bottom-left-radius: 20px;"></div>
                    <div style="position: absolute; bottom: -2px; right: -2px; width: 40px; height: 40px; border-right: 4px solid #4CAF50; border-bottom: 4px solid #4CAF50; border-bottom-right-radius: 20px;"></div>
                    <div class="scan-line" style="width: 100%; height: 2px; background: #4CAF50; box-shadow: 0 0 4px #4CAF50; position: absolute; animation: scanAnim 2s infinite;"></div>
                </div>
                <p style="color: white; margin-top: 20px; font-size: 0.9rem; z-index: 10;">Align QR code within frame</p>
                <button onclick="closeQRScanner()" style="margin-top: 40px; background: rgba(255,255,255,0.2); border: none; padding: 10px 20px; border-radius: 30px; color: white; cursor: pointer; z-index: 10;">
                    Cancel
                </button>
            </div>
        </div>

        <div id="about-screen" class="screen">
            <div class="back-btn" onclick="returnToMenu()" style="top: 20px; left: 20px; box-shadow: none; border: 1px solid #ddd;">
                <i class="fas fa-arrow-left"></i>
            </div>
            
            <div class="about-logo">
                <i class="fas fa-city"></i>
            </div>
            
            <div class="about-content">
                <h1 style="font-family: 'Barabara'; margin-bottom: 5px; color: var(--primary-green);">SILAY EXPLORER</h1>
                <span class="version-tag">Version 1.1.0</span>
                
                <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">
                    Silay Explorer is your ultimate digital guide to the "Paris of Negros." Discover heritage houses, find local cafes, and explore the rich culture of Silay City with our interactive map and events guide.
                </p>
                
                <div class="developer-section">
                    <h4 style="color: var(--text-dark); margin-bottom: 10px;">Developed By</h4>
                    <p style="color: var(--primary-green); font-weight: 600;">College of Computer Studies</p>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Programmer</p>
                    <p style="font-size: 0.8rem; color: #000; margin-top: 5px;">JOHN NIEL FERRER</p>
                    <p style="font-size: 0.8rem; color: #888; margin-top: 5px;">Documents</p>
                    <p style="font-size: 0.8rem; color: #000; margin-top: 5px;">BERNIEL ABAYON</p>
                    <p style="font-size: 0.8rem; color: #000; margin-top: 5px;">FRANCIS SAPICO</p>
                    <p style="font-size: 0.8rem; color: #000; margin-top: 5px;">KARL DANEIL DEQUILLA</p>
                </div>
                
                <div style="margin-top: 40px;">
                    <button class="btn-primary" onclick="window.location.href='mailto:support@silayexplorer.com'">Contact Support</button>
                </div>
            </div>
        </div>

        <div id="support-screen" class="screen">
            <div style="background: var(--primary-green); height: 200px; padding: 20px; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
                <div class="back-btn" onclick="returnToMenu()" style="position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <i class="fas fa-heart" style="font-size: 3rem; margin-bottom: 15px; animation: pulse 1.5s infinite;"></i>
                <h2 style="font-family: 'Barabara'; letter-spacing: 1px;">Support the Devs</h2>
                <p style="font-size: 0.9rem; opacity: 0.9;">Fuel our coding sessions with coffee!</p>
            </div>

            <div class="text-content">
                <p>Silay Explorer is a student project created with love for our city. If you find this app helpful, consider supporting our server costs (and caffeine intake)!</p>
                
                <h3 style="margin-bottom: 15px;">Donate via:</h3>

                <div class="support-card" onclick="copyToClipboard('09266629588', 'GCash')">
                    <div class="support-icon" style="color: #007dfe;">
                        <i class="fas fa-mobile-alt"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #333;">GCash</h4>
                        <p style="margin: 0; font-size: 0.8rem;">Tap to copy number</p>
                    </div>
                    <i class="far fa-copy" style="color: #aaa;"></i>
                </div>

                <div class="support-card" onclick="window.open('https://www.buymeacoffee.com', '_blank')">
                    <div class="support-icon" style="color: #FFDD00;">
                        <i class="fas fa-coffee"></i>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: #333;">Buy us a Coffee</h4>
                        <p style="margin: 0; font-size: 0.8rem;">External Link</p>
                    </div>
                    <i class="fas fa-external-link-alt" style="color: #aaa;"></i>
                </div>

                <div style="margin-top: 30px; text-align: center;">
                    <p style="font-size: 0.8rem; color: #999;"> CCS Department ‚Ä¢ Silay Institute, Inc.</p>
                </div>
            </div>
        </div>

        <div id="privacy-screen" class="screen">
            <div style="background: var(--primary-green); padding: 60px 20px 40px; color: white;">
                <div class="back-btn" onclick="returnToMenu()" style="position: absolute; top: 20px; left: 20px; background: rgba(255,255,255,0.2); color: white;">
                    <i class="fas fa-arrow-left"></i>
                </div>
                <h2 style="font-family: 'Barabara'; margin: 0;">Privacy Policy</h2>
                <p style="opacity: 0.8; font-size: 0.9rem;">Last Updated: Dec 2025</p>
            </div>

            <div class="text-content">
                <h3>1. Data Collection</h3>
                <p>Silay Explorer is a prototype application. We do not store your personal data, location history, or search queries on any external server. All data is processed locally on your device.</p>

                <h3>2. Location Services</h3>
                <p>We use your device's GPS solely to calculate routes to tourist destinations within Silay City. This location data is not shared with third parties.</p>

                <h3>3. Camera Access</h3>
                <p>Camera permission is required only for the QR Scanner feature to read heritage markers. No images or videos are saved or transmitted.</p>

                <h3>4. Contact Us</h3>
                <p>
    If you have any questions regarding this policy, please contact the developer, 
    <a href="https://web.facebook.com/FerrerJN" target="_blank">John Niel Ferrer</a>, 
    via Facebook.
</p>

                <button class="btn-primary" style="width: 100%; margin-top: 20px;" onclick="showScreen('home-screen')">I Understand</button>
            </div>
        </div>

        <div id="chat-screen" class="chat-screen-overlay">
            <div class="chat-header">
                <i class="fas fa-arrow-left" onclick="toggleChat()" style="cursor: pointer;"></i>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="width: 35px; height: 35px; background: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: var(--primary-green);">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div>
                        <h3 style="font-size: 1rem; margin: 0;">Larga Ta Silay AI</h3>
                        <p style="font-size: 0.7rem; margin: 0; opacity: 0.8;">Always active</p>
                    </div>
                </div>
            </div>

            <div class="chat-messages" id="chat-messages">
                <div class="message bot">
                    Hello! I'm Larga your Silay Explorer guide. Ask me about heritage houses, food, or events! üå¥
                </div>
            </div>
            
            <p id="typing-indicator" class="typing-indicator">Silay AI is typing...</p>

            <div class="chat-input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Ask about Silay..." onkeypress="handleEnter(event)">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>

    </div>

<script>
    // --- !!! GROQ API CONFIGURATION !!! ---
    const API_KEY = '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'; 
    // ---------------------------------------

    // --- DATA FOR PLACES (Static Knowledge) ---
    const placesData = {
        balay: {
            title: "Balay Negrense",
            loc: "Cinco de Noviembre St.",
            desc: "The first museum in Negros Occidental, showcasing the lifestyle of a 19th-century sugar baron. A must-visit heritage house!",
            img: "Negrense.jpg"
        },
        larga: {
            title: "Larga Cafe",
            loc: "J Pitong, Calle Ledesma St.",
            desc: "A rustic cafe offering the best local coffee and delicacies amidst the scenic views of Silay's countryside.",
            img: "larga.jpg"
        },
        ilaya: {
            title: "Ilaya Highland Resort",
            loc: "Patag, Silay City",
            desc: "Ilaya Highland Resort offers breathtaking mountain views, cool breezes, and relaxing pools nestled in the highlands of Patag.",
            img: "Illaya.jpg"
        }
    };

    // --- ATTRACTION DATABASE ---
    const attractionDb = [
        { id: 1, name: "Balay Negrense", category: "history", time: "09:00 AM", key: "balay" },
        { id: 2, name: "San Diego Cathedral", category: "history", time: "10:30 AM" },
        { id: 3, name: "El Ideal Bakery", category: "food", time: "11:30 AM" },
        { id: 4, name: "Balay Puti", category: "food", time: "12:30 PM" },
        { id: 5, name: "Bernardino Jalandoni", category: "history", time: "02:00 PM" },
        { id: 6, name: "Silay Public Plaza", category: "nature", time: "03:30 PM" },
        { id: 7, name: "Patag Eco Park", category: "nature", time: "08:00 AM", key: "ilaya" },
        { id: 8, name: "Lantawan View", category: "nature", time: "10:00 AM" },
        { id: 9, name: "Larga Cafe", category: "adventure", time: "02:00 PM", key: "larga" },
        { id: 10, name: "Punong Gary's", category: "food", time: "06:00 PM" },
        { id: 11, name: "Mangrove Eco-Park", category: "adventure", time: "04:00 PM" }
    ];

    // --- GLOBAL VARIABLES ---
    let selectedCategories = [];
    let selectedDuration = null;
    let generatedItinerary = [];
    let destinationLat = null; 
    let destinationLng = null;
    let currentSheetPlaceKey = null;

    // --- NAVIGATION FUNCTIONS ---
    function showScreen(screenId) {
        const screens = document.querySelectorAll('.screen');
        screens.forEach(screen => {
            screen.classList.remove('active');
            screen.style.display = 'none'; 
        });

        const activeScreen = document.getElementById(screenId);
        if (activeScreen) {
            // FIX: Restore flex display for landing screen, otherwise default to block
            if (screenId === 'landing-screen') {
                activeScreen.style.display = 'flex';
            } else {
                activeScreen.style.display = 'block';
            }
            
            setTimeout(() => {
                activeScreen.classList.add('active');
            }, 10);
        }
    }
    
    // --- NEW FUNCTION: RETURN TO MENU ---
    // This function returns to home and immediately re-opens the side menu
    function returnToMenu() {
        // First, go to home screen (background)
        showScreen('home-screen');
        
        // Slight delay to ensure DOM is ready, then open menu
        setTimeout(() => {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('menu-overlay');
            
            // Force open the menu
            if (!menu.classList.contains('active')) {
                menu.classList.add('active');
                overlay.classList.add('active');
            }
        }, 50);
    }

    function checkItinerary() {
        if (generatedItinerary.length === 0) {
            showScreen('itinerary-setup-screen');
        } else {
            showScreen('itinerary-screen');
        }
    }

    function openDetail(placeKey) {
        const data = placesData[placeKey];
        if (data) {
            document.getElementById('detail-title').innerText = data.title;
            document.getElementById('detail-loc').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${data.loc}`;
            document.getElementById('detail-desc').innerText = data.desc;
            document.getElementById('detail-img').src = data.img;
            
            // Reset Bookmark state on new open
            const btn = document.getElementById('bookmark-btn');
            const icon = btn.querySelector('i');
            icon.className = 'far fa-bookmark';

            showScreen('detail-screen');
        } else {
            showToast("Details", "Detailed view not available for this map location.", "fas fa-info");
        }
    }

    // --- NEW: POST-LOGIN NOTIFICATION LOGIC ---
    function triggerHomeNotification() {
        // We set a small delay (e.g., 2 seconds) so the user settles on the home screen first
        setTimeout(() => {  
            // 1. Show the Red Dot on the bell
            const redDot = document.getElementById('red-dot');
            if (redDot) redDot.classList.add('visible');

            // 2. Show the Toast Popup
            showToast('Nearby Attraction!', 'You are near the Ruins. Tap to see details.', 'fas fa-camera');
            
            // 3. Add the notification to the Notification Drawer list dynamically
            const notifList = document.getElementById('notif-list');
            const newItem = document.createElement('div');
            newItem.className = 'notif-item unread';
            newItem.innerHTML = `
                <div class="notif-icon-box" style="color: #FF5722;"><i class="fas fa-camera"></i></div>
                <div class="notif-text">
                    <h4>Nearby Attraction!</h4>
                    <p>You are near the <b>Ruins</b>. Tap to see details.</p>
                    <span class="notif-time">Just now</span>
                </div>
            `;
            // Insert at the top of the list
            notifList.insertBefore(newItem, notifList.firstChild);
        }, 2000); // 2000ms = 2 seconds delay after login
    }

    // --- AUTHENTICATION LOGIC (UPDATED) ---
    
    function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;

        // Simple validation (Prototype only)
        if (email.trim() === "" || pass.trim() === "") {
            showToast("Error", "Please fill in all fields.", "fas fa-exclamation-triangle");
            return;
        }

        // Simulate API call delay
        const btn = event.target; // Get button
        const originalText = btn.innerText;
        btn.innerText = "Signing in...";
        btn.style.opacity = "0.7";

        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.opacity = "1";
            
            showToast("Success", "Welcome back to Silay!", "fas fa-check-circle");
            
            // Navigate to Home
            showScreen('home-screen');

            // TRIGGER THE NOTIFICATION HERE
            triggerHomeNotification(); 

        }, 1000);
    }

    function handleSignup() {
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const pass = document.getElementById('signup-pass').value;

        if (name.trim() === "" || email.trim() === "" || pass.trim() === "") {
            showToast("Error", "Please complete the form.", "fas fa-exclamation-triangle");
            return;
        }

        const btn = event.target;
        const originalText = btn.innerText;
        btn.innerText = "Creating...";
        btn.style.opacity = "0.7";

        setTimeout(() => {
            btn.innerText = originalText;
            btn.style.opacity = "1";
            showToast("Account Created", "Welcome, " + name + "!", "fas fa-user-plus");
            
            showScreen('home-screen');

            // TRIGGER THE NOTIFICATION HERE
            triggerHomeNotification(); 

        }, 1500);
    }

    function handleLogout() {
        // Close menu first
        toggleMenu();
        
        // Show confirmation or just logout
        showToast("Logged Out", "See you again soon!", "fas fa-sign-out-alt");
        
        // Clear inputs (optional)
        document.getElementById('login-email').value = "";
        document.getElementById('login-pass').value = "";
        
        // Go back to login
        showScreen('login-screen');
    }

    // --- ITINERARY LOGIC ---
    function togglePref(element, category) {
        element.classList.toggle('selected');
        if (selectedCategories.includes(category)) {
            selectedCategories = selectedCategories.filter(c => c !== category);
        } else {
            selectedCategories.push(category);
        }
    }

    function selectDuration(element, duration) {
        document.querySelectorAll('.duration-chip').forEach(chip => chip.classList.remove('selected'));
        element.classList.add('selected');
        selectedDuration = duration;
    }

    function generateItinerary() {
        if (selectedCategories.length === 0 || !selectedDuration) {
            alert("Please select at least one interest and a duration.");
            return;
        }
        let filtered = attractionDb.filter(place => selectedCategories.includes(place.category));
        const limit = selectedDuration === 'half' ? 3 : 6;
        filtered.sort(() => 0.5 - Math.random());
        generatedItinerary = filtered.slice(0, limit);
        renderItinerary();
        showScreen('itinerary-screen');
    }

    function renderItinerary() {
        const listContainer = document.getElementById('generated-list');
        listContainer.innerHTML = ""; 
        if (generatedItinerary.length === 0) {
            listContainer.innerHTML = '<li style="text-align: center; color: #999; padding: 20px;">No matching places found. Try selecting more interests!</li>';
            return;
        }
        document.getElementById('itinerary-subtitle').innerText = 
            selectedDuration === 'half' ? "Half Day Tour" : "Full Day Adventure";

        generatedItinerary.forEach((place) => {
            const li = document.createElement('li');
            li.className = 'dynamic-item';
            li.innerHTML = `
                <input type="checkbox" class="item-checkbox" checked onchange="toggleItemStatus(this)">
                <div class="item-info">
                    <span class="item-time">${place.time}</span>
                    <h4>${place.name}</h4>
                    <p>${place.category.charAt(0).toUpperCase() + place.category.slice(1)}</p>
                </div>
            `;
            listContainer.appendChild(li);
        });
    }

    function toggleItemStatus(checkbox) {
        const itemRow = checkbox.parentElement;
        if (checkbox.checked) {
            itemRow.classList.remove('disabled');
        } else {
            itemRow.classList.add('disabled');
        }
    }

    // --- NEW: CUSTOM ITINERARY BUILDER LOGIC ---
    let customSelections = []; // Stores IDs of selected places

    function openCustomBuilder() {
        customSelections = []; // Reset selections
        renderCustomBuilder();
        updateSelectionCount();
        showScreen('custom-itinerary-select-screen');
    }

    function renderCustomBuilder() {
        const container = document.getElementById('custom-list-container');
        container.innerHTML = "";

        // Loop through the existing global attractionDb
        attractionDb.forEach(place => {
            const item = document.createElement('div');
            item.className = 'custom-list-item';
            item.onclick = () => toggleCustomItem(item, place.id);
            
            // Icon based on category
            let icon = 'fa-map-marker-alt';
            if(place.category === 'food') icon = 'fa-utensils';
            if(place.category === 'history') icon = 'fa-landmark';
            if(place.category === 'nature') icon = 'fa-tree';

            item.innerHTML = `
                <div class="custom-check" id="check-${place.id}">
                    <i class="fas fa-check" style="font-size: 0.7rem;"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="font-size: 0.95rem; margin-bottom: 2px;">${place.name}</h4>
                    <span style="font-size: 0.75rem; color: #888; text-transform: capitalize;">
                        <i class="fas ${icon}" style="margin-right: 5px;"></i>${place.category}
                    </span>
                </div>
                <div style="font-size: 0.8rem; font-weight: 600; color: var(--secondary-green);">
                    ${place.time}
                </div>
            `;
            container.appendChild(item);
        });
    }

    function toggleCustomItem(element, id) {
        element.classList.toggle('selected');
        
        if (customSelections.includes(id)) {
            customSelections = customSelections.filter(i => i !== id);
        } else {
            customSelections.push(id);
        }
        updateSelectionCount();
    }

    function updateSelectionCount() {
        document.getElementById('count-span').innerText = customSelections.length;
    }

    function finalizeCustomItinerary() {
        if (customSelections.length === 0) {
            showToast("Empty List", "Please select at least one place.", "fas fa-exclamation-circle");
            return;
        }

        // 1. Filter the main DB to get full objects of selected IDs
        // We ensure they are sorted by their default time in the DB
        generatedItinerary = attractionDb.filter(place => customSelections.includes(place.id));
        
        // 2. Set the global duration variable just for UI display purposes
        selectedDuration = 'custom'; 

        // 3. Render and Show
        renderItinerary(); // Reuses your existing function!
        
        // Update subtitle manually for custom trip
        document.getElementById('itinerary-subtitle').innerText = "Custom Trip Plan";
        
        showScreen('itinerary-screen');
    }

    // --- MENU & UI LOGIC ---
    function closeAllMenus() {
        document.getElementById('side-menu').classList.remove('active');
        document.getElementById('notif-drawer').classList.remove('active');
        document.getElementById('menu-overlay').classList.remove('active');
    }

    function toggleMenu() {
        const menu = document.getElementById('side-menu');
        const overlay = document.getElementById('menu-overlay');
        const notif = document.getElementById('notif-drawer');
        if (notif.classList.contains('active')) notif.classList.remove('active');
        if (menu.classList.contains('active')) {
            menu.classList.remove('active');
            overlay.classList.remove('active');
        } else {
            menu.classList.add('active');
            overlay.classList.add('active');
        }
    }

    function toggleNotifications() {
        const notif = document.getElementById('notif-drawer');
        const menu = document.getElementById('side-menu');
        const overlay = document.getElementById('menu-overlay');
        const redDot = document.getElementById('red-dot');
        if (menu.classList.contains('active')) menu.classList.remove('active');
        if (notif.classList.contains('active')) {
            notif.classList.remove('active');
            overlay.classList.remove('active');
        } else {
            notif.classList.add('active');
            overlay.classList.add('active');
            redDot.classList.remove('visible');
        }
    }

    // --- NEW: GENERIC TOAST NOTIFICATION ---
    function showToast(title, message, iconClass = "fas fa-info-circle") {
        const toast = document.getElementById('toast-notification');
        document.getElementById('toast-title').innerText = title;
        document.getElementById('toast-msg').innerText = message;
        
        // Reset and show
        toast.classList.remove('show');
        void toast.offsetWidth; // Trigger reflow
        toast.classList.add('show');
        
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }

    // --- NEW: MAP BUTTON HANDLERS ---
    function handleMapAction(action) {
        switch(action) {
            case 'explore':
                // Open Google Maps Directions
                if (destinationLat && destinationLng) {
                    showToast('Opening Maps', 'Calculating route from your location...', 'fas fa-route');
                    // Get current user location for best accuracy
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const userLat = position.coords.latitude;
                                const userLng = position.coords.longitude;
                                window.open(`https://www.google.com/maps/dir/?api=1&origin=${userLat},${userLng}&destination=${destinationLat},${destinationLng}&travelmode=driving`, '_blank');
                            },
                            () => {
                                // Fallback if user denies location
                                window.open(`https://www.google.com/maps/dir/?api=1&destination=${destinationLat},${destinationLng}`, '_blank');
                            }
                        );
                    } else {
                        window.open(`https://www.google.com/maps/dir/?api=1&destination=${destinationLat},${destinationLng}`, '_blank');
                    }
                } else {
                    showToast('Error', 'Please select a location on the map first.', 'fas fa-exclamation-circle');
                }
                break;
            case 'call':
                window.location.href = "tel:+639123456789"; 
                break;
            case 'website':
                showToast('Opening Website', 'Redirecting to official website...', 'fas fa-globe');
                break;
            case 'book':
                showToast('Booking Request', 'Checking availability for today...', 'fas fa-calendar-check');
                break;
        }
    }

    // --- NEW: BOOKMARK HANDLER ---
    function toggleBookmark(btn) {
        const icon = btn.querySelector('i');
        if (icon.classList.contains('far')) {
            icon.classList.remove('far');
            icon.classList.add('fas'); // Solid icon
            showToast('Saved', 'Added to your favorites list.', 'fas fa-heart');
        } else {
            icon.classList.remove('fas');
            icon.classList.add('far'); // Outline icon
            showToast('Removed', 'Removed from favorites.', 'far fa-heart');
        }
    }

    // --- NEW: TAB SWITCHER ---
    function switchTab(clickedTab) {
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        // Add active class to clicked tab
        clickedTab.classList.add('active');
        
        // Update content just to show it works
        const content = document.getElementById('detail-desc');
        const tabName = clickedTab.innerText;
        
        if (tabName === "Overview") {
             // Use original text if available, or placeholder
             const currentTitle = document.getElementById('detail-title').innerText;
             // Find original desc from data if possible, else generic
             content.innerText = "The first museum in Negros Occidental, showcasing the lifestyle of a 19th-century sugar baron. A must-visit heritage house!";
        } else if (tabName === "Photos") {
            content.innerText = "No additional photos available in offline mode.";
        } else if (tabName === "Details") {
            content.innerText = "Open daily: 8:00 AM - 5:00 PM. \nEntrance Fee: ‚Ç±50.00";
        } else if (tabName === "Reviews") {
            content.innerText = "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 'Amazing heritage site!' - Juan D.\n‚≠ê‚≠ê‚≠ê‚≠ê 'Great coffee nearby.' - Maria S.";
        }
    }

    // --- NEW: LOADING SCREEN LOGIC ---
    window.addEventListener('load', () => {
        const loader = document.getElementById('preloader');
        const loadingText = document.getElementById('loading-text');
        
        // Minimum wait time for UX
        const MIN_WAIT = 1500;
        const start = Date.now();

        function hideLoader() {
            const elapsed = Date.now() - start;
            const remaining = Math.max(0, MIN_WAIT - elapsed);

            setTimeout(() => {
                loader.style.opacity = '0';
                setTimeout(() => {
                    loader.style.display = 'none';
                    // Show Landing Screen specifically as block (or flex via CSS logic)
                    showScreen('landing-screen');
                }, 500);
            }, remaining);
        }

        // Check Connection
        if (navigator.onLine) {
            hideLoader();
        } else {
            loadingText.innerHTML = "<span style='color: #ffcccc'>No Internet Connection</span>";
            // Wait longer if offline, then show cached version
            setTimeout(hideLoader, 3000);
        }

        // Listen for status changes
        window.addEventListener('offline', () => {
            showToast('You are offline', 'Using cached data.', 'fas fa-wifi-slash');
        });

        window.addEventListener('online', () => {
            showToast('Back Online', 'Connection restored.', 'fas fa-wifi');
        });
    });

    // --- SMART QR SCANNER ---
    let videoStream = null;
    async function openQRScanner() {
        showScreen('qr-screen');
        const video = document.getElementById('qr-video');
        if (!video) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            videoStream = stream;
            video.srcObject = stream;
            video.play();
        } catch (err) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                videoStream = stream;
                video.srcObject = stream;
                video.play();
            } catch (e) {
                alert("Camera failed.");
                showScreen('home-screen');
            }
        }
    }

    function closeQRScanner() {
        const video = document.getElementById('qr-video');
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        if (video) video.srcObject = null;
        showScreen('home-screen');
    }

    // --- REAL-TIME AI CHATBOT LOGIC ---
    function toggleChat() {
        const chatScreen = document.getElementById('chat-screen');
        chatScreen.style.display = chatScreen.style.display === 'flex' ? 'none' : 'flex';
    }

    function handleEnter(e) {
        if (e.key === 'Enter') sendMessage();
    }

    async function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        if (message === "") return;

        addMessage(message, 'user');
        input.value = "";

        const typing = document.getElementById('typing-indicator');
        typing.style.display = 'block';

        // 1. Check Local Knowledge (Faster/Specific)
        const localResponse = getLocalResponse(message);
        
        if (localResponse) {
            setTimeout(() => {
                typing.style.display = 'none';
                addMessage(localResponse, 'bot');
            }, 600);
        } else {
            // 2. Ask Groq (Real-time)
            const apiResponse = await fetchGroqResponse(message);
            typing.style.display = 'none';
            addMessage(apiResponse, 'bot');
        }
    }

    function addMessage(text, sender) {
        const messagesContainer = document.getElementById('chat-messages');
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message', sender);
        // Basic bold formatting support
        msgDiv.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        messagesContainer.appendChild(msgDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // --- HYBRID AI FUNCTIONS ---
    function getLocalResponse(input) {
        input = input.toLowerCase();
        if (input.includes('kansilay')) return "Kansilay is our annual festival celebrated every June 12! It depicts the legend of Kansilay and the story of the revolution.";
        if (input.includes('developer') || input.includes('creator')) return "This app was developed by the brilliant students of the College of Computer Studies!";
        return null; 
    }

    async function fetchGroqResponse(userMessage) {
        const url = "https://api.groq.com/openai/v1/chat/completions";
        
        // --- UPDATED MODEL NAME HERE ---
        const requestBody = {
            model: "llama-3.3-70b-versatile", // UPDATED: The new supported model
            messages: [
                {
                    role: "system",
                    content: "You are Larga Ta Silay AI, a friendly and witty local tourist guide for Silay City, Philippines. Keep answers short (max 2 sentences), fun, and use emojis."
                },
                {
                    role: "user",
                    content: userMessage
                }
            ]
        };

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${API_KEY}`
                },
                body: JSON.stringify(requestBody)
            });

            const data = await response.json();
            
            // ERROR DEBUGGING
            if (data.error) {
                console.error("Groq Error:", data.error);
                return "‚ö†Ô∏è API Error: " + data.error.message;
            }

            return data.choices[0].message.content;
        } catch (error) {
            console.error("Network Error:", error);
            return "‚ö†Ô∏è Connection Failed: " + error.message + ". (Tip: Check your CORS extension)";
        }
    }

    // --- SEARCH LOGIC (Hybrid: Local + OpenStreetMap API) ---
    let searchTimeout = null;

    function handleSearch(query) {
        const resultsContainer = document.getElementById('search-results');
        const clearBtn = document.getElementById('clear-search');
        
        // Toggle clear button
        if (query.length > 0) clearBtn.style.display = 'block';
        else clearBtn.style.display = 'none';

        // 1. Clear previous timeout to prevent API spamming
        clearTimeout(searchTimeout);
        
        if (query.length < 2) {
            resultsContainer.classList.remove('active');
            resultsContainer.innerHTML = '';
            return;
        }

        // 2. Wait 500ms after typing stops, then search
        searchTimeout = setTimeout(async () => {
            resultsContainer.innerHTML = '<div style="padding:15px; color:#888; text-align:center;"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';
            resultsContainer.classList.add('active');

            // A. Search LOCAL Database first (Instant & curated)
            const localMatches = attractionDb.filter(place => 
                place.name.toLowerCase().includes(query.toLowerCase()) || 
                place.category.toLowerCase().includes(query.toLowerCase())
            );

            // B. Search API (OpenStreetMap Nominatim)
            // We restrict search to "Silay City" to keep it relevant
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query} Silay City Philippines`);
                const apiMatches = await response.json();

                // C. Combine Results
                renderSearchResults(localMatches, apiMatches);
                
            } catch (error) {
                console.error("API Error:", error);
                renderSearchResults(localMatches, []); // Fallback to just local
            }
        }, 500);
    }

    function clearSearch() {
        document.getElementById('trip-search').value = '';
        document.getElementById('search-results').classList.remove('active');
        document.getElementById('clear-search').style.display = 'none';
    }

    function renderSearchResults(local, api) {
        const container = document.getElementById('search-results');
        container.innerHTML = '';

        if (local.length === 0 && api.length === 0) {
            container.innerHTML = '<div style="padding:15px; color:#888; text-align:center;">No results found.</div>';
            return;
        }

        // 1. Render Local Matches (Priority - Top of list)
        local.forEach(place => {
            const div = document.createElement('div');
            div.className = 'search-item';
            div.onclick = () => {
                // Try to open detail page if we have data for it
                openDetailFromSearch(place.name); 
                container.classList.remove('active');
            };
            div.innerHTML = `
                <div style="background: #e8f5e9; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-star" style="font-size: 0.9rem;"></i>
                </div>
                <div>
                    <h4>${place.name}</h4>
                    <p>Local Recommendation ‚Ä¢ ${place.category}</p>
                </div>
            `;
            container.appendChild(div);
        });

        // 2. Render API Matches
        api.forEach(place => {
            // Filter out duplicates if API finds the same place as local
            const isDuplicate = local.some(l => l.name.toLowerCase() === place.display_name.split(',')[0].toLowerCase());
            
            if (!isDuplicate) {
                const div = document.createElement('div');
                div.className = 'search-item';
                div.onclick = () => {
                    openMapLocation(place.lat, place.lon, place.display_name.split(',')[0]);
                    container.classList.remove('active');
                };
                div.innerHTML = `
                      <div style="background: #f5f5f5; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-map-marker-alt" style="font-size: 0.9rem; color: #888;"></i>
                    </div>
                    <div>
                        <h4>${place.display_name.split(',')[0]}</h4>
                        <p>${place.type} ‚Ä¢ via OpenStreetMap</p>
                    </div>
                `;
                container.appendChild(div);
            }
        });
    }

    // --- HELPER FUNCTIONS FOR CLICKING RESULTS ---

    function openDetailFromSearch(name) {
        // Simple lookup to see if we have a full detail page for this search result
        let key = null;
        if (name.includes("Balay Negrense")) key = 'balay';
        if (name.includes("Larga")) key = 'larga';
        if (name.includes("Ilaya")) key = 'ilaya';

        if (key) {
            openDetail(key); // Use your existing Detail function
        } else {
            // If we don't have a detail page, just map it
            // Search API for coords since we only have name
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${name} Silay City`)
                .then(res => res.json())
                .then(data => {
                    if(data.length > 0) openMapLocation(data[0].lat, data[0].lon, name);
                });
        }
    }

    // --- LEAFLET MAP LOGIC (Free & Interactive) ---
    let map = null;
    let currentMarkers = [];

    // Coordinates for Silay City, Philippines
    const SILAY_COORDS = [10.797, 122.970]; 

    function initMap() {
        // Only initialize if not already done
        if (map !== null) return;

        // 1. Create the map centered on Silay
        map = L.map('leaflet-map', { zoomControl: false }).setView(SILAY_COORDS, 14);

        // 2. Add the OpenStreetMap tiles (The visual map)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // 3. Add Custom Pins from your Database
        loadMapMarkers();
    }

    function loadMapMarkers() {
        // Combine your attractionDb with coordinate data (Simulated for prototype)
        // In a real app, your DB would have lat/lng. Here we approximate slightly for demo.
        const placesWithCoords = [
            { name: "Balay Negrense", lat: 10.798, lng: 122.972, type: "history", key: "balay" },
            { name: "San Diego Cathedral", lat: 10.800, lng: 122.975, type: "history" },
            { name: "El Ideal Bakery", lat: 10.799, lng: 122.974, type: "food" },
            { name: "Silay Public Plaza", lat: 10.800, lng: 122.976, type: "nature" },
            { name: "Larga Cafe", lat: 10.785, lng: 123.000, type: "adventure", key: "larga" }, // Highlands approximation
            { name: "Patag Eco Park", lat: 10.700, lng: 123.150, type: "nature", key: "ilaya" }
        ];

        placesWithCoords.forEach(place => {
            // Create a marker
            const marker = L.marker([place.lat, place.lng]).addTo(map);
            
            // Add click event to open your Bottom Sheet
            marker.on('click', () => {
                openBottomSheet(place.name, place.type, place.lat, place.lng, place.key);
                
                // Zoom to marker
                map.flyTo([place.lat, place.lng], 16, {
                    animate: true,
                    duration: 1.5
                });
            });
        });
    }

    // --- MAP SPECIFIC SEARCH LOGIC ---
    let mapSearchTimeout = null;
    function handleMapSearch(query) {
        const resultsContainer = document.getElementById('map-search-results');
        
        clearTimeout(mapSearchTimeout);
        if (query.length < 2) {
            resultsContainer.classList.remove('active');
            resultsContainer.innerHTML = '';
            return;
        }

        mapSearchTimeout = setTimeout(async () => {
            resultsContainer.classList.add('active');
            resultsContainer.innerHTML = '<div style="padding:15px; color:#888;">Searching...</div>';

            try {
                // Search OSM API
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query} Silay City Philippines`);
                const apiMatches = await response.json();
                
                resultsContainer.innerHTML = '';
                if(apiMatches.length === 0) {
                    resultsContainer.innerHTML = '<div style="padding:15px; color:#888;">No results</div>';
                    return;
                }

                apiMatches.forEach(place => {
                    const div = document.createElement('div');
                    div.className = 'search-item';
                    div.onclick = () => {
                        openMapLocation(place.lat, place.lon, place.display_name.split(',')[0]);
                        resultsContainer.classList.remove('active');
                        document.querySelector('.map-search-bar input').value = ''; // Clear input
                    };
                    div.innerHTML = `
                        <div style="background: #f5f5f5; padding: 8px; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-map-marker-alt" style="color: var(--primary-green);"></i>
                        </div>
                        <div>
                            <h4>${place.display_name.split(',')[0]}</h4>
                            <p style="font-size:0.7rem;">${place.type}</p>
                        </div>
                    `;
                    resultsContainer.appendChild(div);
                });

            } catch (e) {
                console.error(e);
            }
        }, 500);
    }

    function openBottomSheet(name, category, lat, lng, key = null) {
        const sheet = document.getElementById('map-sheet');
        destinationLat = lat; // Store for explore function
        destinationLng = lng;
        currentSheetPlaceKey = key; // Store key for "Explore" button in sheet

        // 1. Update Title & Desc
        document.getElementById('sheet-title').innerText = name;
        document.getElementById('sheet-desc').innerText = "Silay City ‚Ä¢ " + (category ? category.toUpperCase() : "PLACE");
        
        // 2. Update Photos (Dynamic Logic)
        const photoContainer = document.getElementById('sheet-photos');
        photoContainer.innerHTML = ''; // Clear old photos

        if (key && placesData[key]) {
            // CASE A: Local Data (Real Photos)
            const img = document.createElement('img');
            img.src = placesData[key].img;
            img.className = 'map-photo';
            photoContainer.appendChild(img);
            
            // Add duplicate for scroll effect demo
            const img2 = document.createElement('img');
            img2.src = placesData[key].img; 
            img2.className = 'map-photo';
            photoContainer.appendChild(img2);
        } else {
            // CASE B: API/Generic Result (Placeholder Photos)
            // Use a nice unsplash placeholder
            const placeholder = document.createElement('img');
            placeholder.src = "https://images.unsplash.com/photo-1590490360182-c33d57733427?q=80&w=200"; 
            placeholder.className = 'map-photo';
            photoContainer.appendChild(placeholder);
        }

        sheet.style.display = 'block';
    }

    function closeBottomSheet() {
        document.getElementById('map-sheet').style.display = 'none';
        destinationLat = null;
        destinationLng = null;
    }

    // UPDATE: Modify your existing 'showScreen' function to load map on demand
    const originalShowScreen = showScreen; // Save old function
    showScreen = function(screenId) {
        originalShowScreen(screenId); // Call original
        
        if (screenId === 'map-screen') {
            // We need a slight delay to let the div become visible before Leaflet calculates size
            setTimeout(() => {
                initMap();
                map.invalidateSize(); // Fixes grey map tiles
            }, 300);
        }
    }

    // UPDATE: Modify your search result click to fly to the location
    function openMapLocation(lat, lon, name) {
        showScreen('map-screen');
        setTimeout(() => {
            initMap(); // Ensure map exists
            map.flyTo([lat, lon], 16);
            
            // Add a temporary marker for the searched location
            const searchMarker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`<b>${name}</b>`).openPopup();
                
            openBottomSheet(name, "Searched Location", lat, lon);
        }, 500);
    }

    // ==========================================
    // --- REAL-TIME CALENDAR & EVENTS LOGIC ---
    // ==========================================

    // 1. THE "MOCK API" DATABASE (Silay Events)
    const silayEventsAPI = [
        { title: "Silay City Charter Day", date: "2025-06-12", img: "https://images.unsplash.com/photo-1596422846543-75c6a197da74", loc: "City Hall", desc: "Commemoration of the signing of the charter." },
        { title: "Kansilay Festival", date: "2025-06-12", img: "https://images.unsplash.com/photo-1533227297464-946a36230e71", loc: "Public Plaza", desc: "The legend of Kansilay street dance parade." },
        { title: "Feast of San Diego", date: "2025-11-13", img: "https://images.unsplash.com/photo-1519671482538-307157d83326", loc: "San Diego Cathedral", desc: "Religious feast honoring the patron saint." },
        { title: "Adobo Festival", date: "2025-11-05", img: "https://images.unsplash.com/photo-1606787366850-de6330128bfc", loc: "Balay Negrense", desc: "Annual cook-off of the famous Negros Adobo." },
        { title: "Cinco de Noviembre", date: "2025-11-05", img: "https://images.unsplash.com/photo-1590490360182-c33d57733427", loc: "Farmacia Locsin", desc: "Historical reenactment of the Negros Revolution." },
        { title: "Christmas Lighting", date: "2025-12-10", img: "https://images.unsplash.com/photo-1512389142860-9c449e58a543", loc: "Public Plaza", desc: "Grand lighting of the Christmas Village." },
        { title: "New Year Countdown", date: "2025-12-31", img: "https://images.unsplash.com/photo-1467810563316-b5476525c0f9", loc: "City Hall Grounds", desc: "Fireworks and live band countdown." }
    ];

    let currDate = new Date();
    let currMonth = currDate.getMonth();
    let currYear = currDate.getFullYear();

    const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

    // Initialize Calendar on Load
    function initCalendar() {
        renderCalendar(currMonth, currYear);
        renderEventsList(currMonth, currYear);
    }

    // Call this immediately
    initCalendar();

    function renderCalendar(month, year) {
        const daysContainer = document.getElementById('calendar-days');
        const monthTitle = document.getElementById('current-month');
        const yearTitle = document.getElementById('current-year');

        monthTitle.innerText = monthNames[month];
        yearTitle.innerText = year;
        daysContainer.innerHTML = "";

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Empty slots for previous month
        for (let i = 0; i < firstDay; i++) {
            const emptyDiv = document.createElement('div');
            emptyDiv.style.width = "14.28%"; 
            emptyDiv.style.height = "40px";
            daysContainer.appendChild(emptyDiv);
        }

        // Days generation
        for (let i = 1; i <= daysInMonth; i++) {
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('cal-date');
            dayDiv.innerText = i;
            dayDiv.style.width = "14.28%";
            dayDiv.style.height = "40px";
            dayDiv.style.display = "flex";
            dayDiv.style.justifyContent = "center";
            dayDiv.style.alignItems = "center";
            
            // Construct date string YYYY-MM-DD for checking events
            const checkMonth = (month + 1).toString().padStart(2, '0');
            const checkDay = i.toString().padStart(2, '0');
            const fullDate = `${year}-${checkMonth}-${checkDay}`;

            // Check if Today
            const today = new Date();
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                dayDiv.classList.add('today');
            }

            // Check if Event exists (Real-time check)
            const hasEvent = silayEventsAPI.some(e => e.date === fullDate);
            if (hasEvent) {
                dayDiv.classList.add('has-event');
                dayDiv.innerHTML += `<div class="event-indicator"></div>`;
            }

            // Click event to filter list
            dayDiv.onclick = () => {
                document.querySelectorAll('.cal-date').forEach(d => d.style.backgroundColor = "transparent");
                document.querySelectorAll('.cal-date').forEach(d => d.style.color = "#333");
                
                dayDiv.style.backgroundColor = "#2F5245";
                dayDiv.style.color = "white";
                dayDiv.style.borderRadius = "50%";
                
                // Filter the list below
                filterEventsByDate(fullDate);
            };

            daysContainer.appendChild(dayDiv);
        }
    }

    function changeMonth(direction) {
        currMonth += direction;
        if (currMonth < 0) {
            currMonth = 11;
            currYear--;
        } else if (currMonth > 11) {
            currMonth = 0;
            currYear++;
        }
        renderCalendar(currMonth, currYear);
        renderEventsList(currMonth, currYear); // Show all events for new month
    }

    function goToToday() {
        const today = new Date();
        currMonth = today.getMonth();
        currYear = today.getFullYear();
        renderCalendar(currMonth, currYear);
        renderEventsList(currMonth, currYear);
    }

    // Render the cards at the bottom
    function renderEventsList(month, year) {
        const container = document.getElementById('upcoming-events-container');
        container.innerHTML = "";

        // Filter events for this specific Month & Year
        const monthlyEvents = silayEventsAPI.filter(e => {
            const eventDate = new Date(e.date);
            return eventDate.getMonth() === month && eventDate.getFullYear() === year;
        });

        if (monthlyEvents.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">No events scheduled for this month.</div>`;
            return;
        }

        monthlyEvents.forEach(evt => createEventCard(evt, container));
    }

    function filterEventsByDate(dateStr) {
        const container = document.getElementById('upcoming-events-container');
        container.innerHTML = "";
        
        const specificEvents = silayEventsAPI.filter(e => e.date === dateStr);

        if (specificEvents.length === 0) {
            container.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">No events on this specific day.</div>`;
        } else {
            specificEvents.forEach(evt => createEventCard(evt, container));
        }
    }

    function createEventCard(evt, container) {
        const dateObj = new Date(evt.date);
        const dateString = dateObj.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });

        const card = document.createElement('div');
        card.className = 'event-card';
        card.innerHTML = `
            <img src="${evt.img}" style="width: 100%; height: 160px; object-fit: cover;">
            <div style="padding: 20px;">
                <div style="display:flex; justify-content:space-between;">
                    <h3 style="margin-bottom: 5px;">${evt.title}</h3>
                    <span style="color:var(--primary-green); font-weight:bold; font-size:0.8rem;">${dateString}</span>
                </div>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 10px;">${evt.desc}</p>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
                    <span style="font-size: 0.85rem; color: #888;"><i class="fas fa-map-marker-alt"></i> ${evt.loc}</span>
                    <button onclick="showToast('Event Added', 'Added ${evt.title} to your itinerary.', 'fas fa-check')" style="background: var(--primary-green); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer;">Interested</button>
                </div>
            </div>
        `;
        container.appendChild(card);
    }
    
    // --- SUPPORT SCREEN HELPER ---
    function copyToClipboard(text, provider) {
        navigator.clipboard.writeText(text).then(() => {
            showToast(`${provider}`, `Number ${text} copied to clipboard!`, "fas fa-clipboard-check");
        }).catch(err => {
            console.error('Failed to copy: ', err);
        });
    }

    //Prevent right click
document.oncontextmenu = () => {
    alert("Don't try right click")
    return false
}

/* Still anyone can inspect elements by F12 key. View page source by 
Ctrl + U key. Copy by Ctrl + C key. Paste by Ctrl + V key. Let's prevent these */

document.onkeydown = e => {
    //Prevent F12 key
    if(e.key == "F12") {
        alert("Don't try to inspect element")
        return false
    }
    //Prevent showing page source by Ctrl + U
    if(e.ctrlKey && e.key == "u") {
        alert("Don't try to view page sources")
        return false
    }
}
</script>
</body>
</html>
